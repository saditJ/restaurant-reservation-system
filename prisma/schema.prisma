generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELLED
}

enum HoldStatus {
  HELD
  CONSUMED
  EXPIRED
}

enum NotificationOutboxStatus {
  PENDING
  SENT
  FAILED
}

enum WebhookDeliveryStatus {
  PENDING
  SUCCESS
  FAILED
}

enum WebhookEvent {
  RESERVATION_CREATED
  RESERVATION_UPDATED
  RESERVATION_CANCELLED
  RESERVATION_SEATED
  RESERVATION_COMPLETED
}

enum CommTemplateKind {
  CONFIRM
  REMINDER
  CANCELLED
  OFFER
}

enum MembershipRole {
  OWNER
  ADMIN
  MANAGER
  VIEWER
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  city      String?
  timezone  String?
  isActive  Boolean  @default(true)
  theme     Json?
  domains   String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venues Venue[]
  plans  TenantPlan[]
  members Membership[]
  apiKeys ApiKey[]
  menus  Menu[]
}

model TenantPlan {
  id              String   @id @default(cuid())
  tenantId        String
  planName        String
  seatsMax        Int
  storageMbMax    Int
  venuesMax       Int
  servicesMax     Int
  localeCountMax  Int
  isRateLimited   Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model User {
  id        String   @id @default(cuid())
  emailEnc  String
  nameEnc   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members Membership[]
}

model Membership {
  userId    String
  tenantId  String
  role      MembershipRole
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@id([userId, tenantId])
  @@index([tenantId, role])
}

model Venue {
  id           String         @id @default(cuid())
  tenantId     String
  name         String
  slug         String?        @unique
  timezone     String         @default("Europe/Tirane")
  address      String?
  city         String?
  state        String?
  country      String?
  postalCode   String?
  phone        String?
  email        String?
  website      String?
  description  String?        @db.Text
  heroImageUrl String?
  gallery      String[]       @default([])
  cuisines     String[]       @default([])
  priceLevel   Int?           // 1-4 scale
  tags         String[]       @default([])
  amenities    String[]       @default([])
  dressCode    String?
  parkingInfo  String?
  publicTransit String?
  hours        Json?
  floorplanRoomWidth  Int? @default(1200)
  floorplanRoomHeight Int? @default(800)
  floorplanGridSize   Int? @default(20)
  turnTimeMin  Int            @default(10)
  holdTtlMin   Int            @default(15)
  defaultDurationMin Int      @default(120)
  cancellationWindowMin Int   @default(120)
  guestCanModifyUntilMin Int  @default(120)
  noShowFeePolicy Boolean     @default(false)
  pacingPerQuarterHour Int    @default(4)
  reminderHoursBefore Int?
  retainPersonalDataDays Int  @default(365)
  isPublic     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  tables            Table[]
  reservations      Reservation[]
  holds             Hold[]
  waitlist          Waitlist[]
  shifts            Shift[]
  availabilityRules AvailabilityRule[]
  blackoutDates     BlackoutDate[]
  pacingRules       PacingRule[]
  serviceBuffer     ServiceBuffer?
  commTemplates     CommTemplate[]
  menus             Menu[]
  reviews           Review[]
  favorites         Favorite[]
  analytics         VenueAnalytics[]

  @@index([tenantId], map: "Venue_tenantId_idx")
  @@index([slug])
  @@index([city])
  @@index([isPublic])
}

model Table {
  id        String   @id @default(cuid())
  venueId   String
  label     String
  capacity  Int
  joinGroupId String?
  zone      String?
  area      String?
  x         Int?    @default(0)
  y         Int?    @default(0)
  angle     Int?    @default(0)
  shape     String?
  w         Int?    @default(60)
  h         Int?    @default(60)
  width     Int?
  height    Int?
  minSeating Int?   @default(1)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venue        Venue        @relation(fields: [venueId], references: [id], onDelete: Cascade)
  reservations Reservation[]
  holds        Hold[]
  assignments  ReservationTableAssignment[]

  @@unique([venueId, label])
  @@index([venueId, capacity])
  @@index([venueId, zone])
}

model Reservation {
  id              String            @id @default(cuid())
  venueId         String
  tableId         String?
  code            String            @unique
  status          ReservationStatus @default(PENDING)
  guestName       String
  guestPhone      String?
  guestEmail      String?
  guestPhoneSearch String?
  guestPhoneLast4 String?
  guestEmailSearch String?
  piiKeyVersion   String?
  reminderSentAt  DateTime?
  piiAnonymizedAt DateTime?
  piiAnonymizedReason String?
  piiAnonymizedToken String?
  partySize       Int
  slotLocalDate   String            // YYYY-MM-DD in venue timezone
  slotLocalTime   String            // HH:MM in venue timezone
  slotStartUtc    DateTime
  durationMinutes Int               @default(120)
  notes           String?
  channel         String?           // guest vs staff vs phone
  createdBy       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  venue       Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)
  table       Table? @relation(fields: [tableId], references: [id], onDelete: SetNull)
  hold        Hold?  @relation("HoldToReservation")
  tables      ReservationTableAssignment[]
  notifications NotificationOutbox[]
  webhookDeliveries WebhookDelivery[]

  @@unique([venueId, tableId, slotLocalDate, slotLocalTime], map: "uniq_reservation_venue_table_slot")
  @@index([venueId, slotLocalDate, slotLocalTime])
  @@index([status])
  @@index([slotStartUtc], map: "idx_reservation_slot_start_utc")
  @@index([venueId, slotLocalDate], map: "idx_reservation_venue_date")
  @@index([venueId, slotStartUtc])
  @@index([piiAnonymizedAt], map: "idx_reservation_pii_anonymized_at")
  @@index([guestEmailSearch], map: "idx_reservation_guest_email_search")
  @@index([guestPhoneSearch], map: "idx_reservation_guest_phone_search")
  @@index([guestPhoneLast4], map: "idx_reservation_guest_phone_last4")
  @@index([status, reminderSentAt, slotStartUtc], map: "idx_reservation_reminder_window")
}

model ReservationTableAssignment {
  reservationId String
  tableId       String
  assignedOrder Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  table       Table       @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@id([reservationId, tableId])
  @@index([tableId])
}

model Hold {
  id            String      @id @default(cuid())
  venueId       String
  tableId       String?
  reservationId String?     @unique
  status        HoldStatus  @default(HELD)
  partySize     Int
  slotLocalDate String
  slotLocalTime String
  slotStartUtc  DateTime
  expiresAt     DateTime
  createdBy     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  metadata      Json?

  venue       Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)
  table       Table?      @relation(fields: [tableId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation("HoldToReservation", fields: [reservationId], references: [id], onDelete: SetNull)
  waitlistEntry Waitlist?  @relation("HoldToWaitlist")

  @@unique([venueId, tableId, slotLocalDate, slotLocalTime], map: "uniq_hold_venue_table_slot")
  @@unique([venueId, slotLocalDate, slotLocalTime, tableId], map: "uniq_hold_venue_slot_table_nullable")
  @@index([status, expiresAt])
  @@index([slotStartUtc], map: "idx_hold_slot_start_utc")
  @@index([venueId, slotLocalDate], map: "idx_hold_venue_date")
  @@index([venueId, slotStartUtc])
}

model Waitlist {
  id        String   @id @default(cuid())
  venueId   String
  name      String
  emailEnc  String
  phoneEnc  String?
  partySize Int
  desiredAt DateTime
  notes     String?
  priority  Int      @default(0)
  status    String   @default("WAITING")
  offerCode String?  @unique
  offerToken String?
  holdId    String?  @unique
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)
  hold  Hold? @relation("HoldToWaitlist", fields: [holdId], references: [id], onDelete: SetNull)

  @@index([venueId, status], map: "idx_waitlist_venue_status")
  @@index([venueId, desiredAt], map: "idx_waitlist_venue_desired_at")
}

model Shift {
  id             String   @id @default(cuid())
  venueId        String
  dow            Int      // 0 (Sunday) - 6 (Saturday)
  startsAtLocal  DateTime @db.Time(0)
  endsAtLocal    DateTime @db.Time(0)
  capacitySeats  Int
  capacityCovers Int
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId, dow])
}

model AvailabilityRule {
  id               String   @id @default(cuid())
  venueId          String
  minPartySize     Int
  maxPartySize     Int
  slotLengthMinutes Int
  bufferMinutes    Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId, minPartySize, maxPartySize])
}

model PacingRule {
  id              String   @id @default(cuid())
  venueId         String
  windowMinutes   Int
  maxReservations Int?
  maxCovers       Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)
}

model BlackoutDate {
  id        String   @id @default(cuid())
  venueId   String
  date      DateTime @db.Date
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId, date])
}

model ServiceBuffer {
  id            String   @id @default(cuid())
  venueId       String   @unique
  beforeMinutes Int      @default(0)
  afterMinutes  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)
}

model NotificationOutbox {
  id             String                    @id @default(cuid())
  type           String
  payload        Json
  status         NotificationOutboxStatus  @default(PENDING)
  attempts       Int                       @default(0)
  lastError      String?
  scheduledAt    DateTime                  @default(now())
  reservationId  String?
  guestContact   String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([status, scheduledAt])
  @@index([reservationId])
}

model WebhookEndpoint {
  id          String    @id @default(cuid())
  url         String
  description String?   @db.VarChar(255)
  isActive    Boolean   @default(true)
  events      WebhookEvent[] @default([])
  secret      String
  secretCreatedAt DateTime @default(now())
  secretRotatedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  deliveries WebhookDelivery[]

  @@unique([url])
}

model WebhookDelivery {
  id             String               @id @default(cuid())
  endpointId     String
  reservationId  String?
  event          WebhookEvent
  payload        Json
  status         WebhookDeliveryStatus @default(PENDING)
  attempts       Int                  @default(0)
  lastError      String?
  nextAttemptAt  DateTime             @default(now())
  deliveredAt    DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  signatureInput String?
  failureReason  String?
  failedAt       DateTime?

  endpoint    WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  reservation Reservation?    @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([endpointId, createdAt])
  @@index([status, nextAttemptAt])
}

model CommTemplate {
  id        String           @id @default(cuid())
  venueId   String
  kind      CommTemplateKind
  subject   String
  html      String
  updatedAt DateTime         @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([venueId, kind])
}

model IdempotencyKey {
  id        String   @id
  method    String
  path      String
  bodyHash  String
  status    Int
  response  Json
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([expiresAt], map: "idx_idempotency_expires_at")
  @@index([id, method, path], map: "idx_idempotency_lookup")
}

model ApiKey {
  id               String   @id @default(cuid())
  tenantId         String
  name             String
  hashedKey        String   @unique
  createdAt        DateTime @default(now())
  lastUsedAt       DateTime?
  isActive         Boolean  @default(true)
  rateLimitPerMin  Int      @default(60)
  burstLimit       Int      @default(30)
  monthlyCap       Int      @default(500000)
  tokenPreview     String?
  scopeJSON        Json?

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, isActive], map: "ApiKey_tenantId_isActive_idx")
}

model AuditLog {
  id        String   @id @default(cuid())
  actor     String
  action    String
  resource  String
  before    Json?
  after     Json?
  route     String?
  method    String?
  statusCode Int?
  requestId String?
  tenantId  String?
  createdAt DateTime @default(now())

  @@index([resource, createdAt], map: "idx_audit_resource_created_at")
  @@index([createdAt], map: "idx_audit_created_at")
  @@index([action], map: "idx_audit_action")
}

model Menu {
  id          String   @id @default(cuid())
  tenantId    String
  venueId     String
  name        String
  description String?
  isActive    Boolean  @default(true)
  isPublic    Boolean  @default(true)
  displayOrder Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  venue    Venue         @relation(fields: [venueId], references: [id], onDelete: Cascade)
  sections MenuSection[]

  @@index([tenantId])
  @@index([venueId, isActive])
  @@index([venueId, isPublic])
}

model MenuSection {
  id          String   @id @default(cuid())
  menuId      String
  title       String
  description String?
  displayOrder Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  menu  Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  items MenuItem[]

  @@index([menuId])
}

model MenuItem {
  id          String   @id @default(cuid())
  sectionId   String
  name        String
  short       String?
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("ALL")
  imageUrl    String?
  isAvailable Boolean  @default(true)
  tags        String[] @default([])
  displayOrder Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  section MenuSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
}

model Review {
  id           String   @id @default(cuid())
  venueId      String
  reservationId String? @unique
  guestName    String
  guestEmail   String?
  rating       Int      // 1-5
  title        String?
  comment      String?  @db.Text
  isVerified   Boolean  @default(false)
  isPublished  Boolean  @default(false)
  response     String?  @db.Text
  respondedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  venue       Venue        @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId, isPublished, createdAt])
  @@index([venueId, rating])
  @@index([createdAt])
}

model Favorite {
  userId    String
  venueId   String
  createdAt DateTime @default(now())

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@id([userId, venueId])
  @@index([userId])
  @@index([venueId])
}

model VenueAnalytics {
  id          String   @id @default(cuid())
  venueId     String
  date        DateTime @db.Date
  views       Int      @default(0)
  searches    Int      @default(0)
  bookings    Int      @default(0)
  favorites   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([venueId, date])
  @@index([venueId, date])
  @@index([date])
}
